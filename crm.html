<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRM Firebase - AMR ADV</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', sans-serif; }
body { display:flex; background:#f0f2f5; height:100vh; }

.sidebar {
    width:220px;
    background:#fff;
    border-right:1px solid #ddd;
    display:flex;
    flex-direction:column;
    padding-top:20px;
}
.sidebar h2 { text-align:center; margin-bottom:20px; font-size:20px; color:#1e1e2f; }
.sidebar button { padding:12px 20px; margin:5px 10px; border:none; background:#f8f9fa; text-align:left; cursor:pointer; border-radius:6px; transition:0.2s; }
.sidebar button:hover { background:#e2e6ea; }

.main { flex:1; display:flex; flex-direction:column; }

header { height:60px; background:#fff; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center; padding:0 20px; }
header h1 { font-size:22px; color:#1e1e2f; }
header button { padding:8px 16px; background:#1e1e2f; color:#fff; border:none; border-radius:6px; cursor:pointer; }

.search-bar { padding:10px 20px; background:#fff; border-bottom:1px solid #ddd; display:flex; gap:10px; align-items:center; }
.search-bar input { flex:1; padding:8px; border:1px solid #ccc; border-radius:6px; }
.search-bar select { padding:8px; border-radius:6px; border:1px solid #ccc; }

.kanban { display:flex; gap:20px; padding:20px; overflow-x:auto; flex:1; }

.column { background:#fff; border-radius:10px; padding:15px; min-width:250px; max-height:calc(100vh - 140px); display:flex; flex-direction:column; gap:10px; box-shadow:0 4px 8px rgba(0,0,0,0.05); }
.column h2 { margin-bottom:10px; font-size:18px; color:#1e1e2f; }

.card { padding:12px; border-radius:8px; cursor:grab; transition:all 0.2s ease; color:#fff; position:relative; }
.card:hover { opacity:0.9; }

.prospect { background:#3498db; }
.negociacao { background:#f1c40f; color:#000; }
.contrato-assinado { background:#9b59b6; }
.fechado { background:#2ecc71; }

.card h3 { font-size:16px; margin-bottom:5px; }
.card p { font-size:14px; }

.card button {
    position:absolute;
    top:5px;
    right:5px;
    background:rgba(0,0,0,0.2);
    border:none;
    color:#fff;
    padding:2px 6px;
    border-radius:4px;
    cursor:pointer;
    font-size:12px;
    margin-left:2px;
}
.card button:hover { background:rgba(0,0,0,0.4); }
</style>
</head>
<body>

<div class="sidebar">
    <h2>AMR ADV</h2>
    <button onclick="alert('Fun√ß√£o de relat√≥rios')">Relat√≥rios</button>
    <button onclick="alert('Fun√ß√£o de agenda')">Agenda</button>
    <button onclick="alert('Fun√ß√£o de contatos')">Contatos</button>
    <button onclick="alert('Fun√ß√£o de configura√ß√µes')">Configura√ß√µes</button>
</div>

<div class="main">
    <header>
        <h1>CRM Firebase</h1>
        <button onclick="novoCliente()">Adicionar Cliente</button>
    </header>

    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Buscar cliente..." oninput="filtrarClientes()">
        <select id="filterStatus" onchange="filtrarClientes()">
            <option value="">Todos os status</option>
            <option value="prospect">Prospect</option>
            <option value="negociacao">Negocia√ß√£o</option>
            <option value="contrato-assinado">Contrato Assinado</option>
            <option value="fechado">Fechado</option>
        </select>
    </div>

    <main class="kanban">
        <div class="column" id="prospect"><h2>Prospect</h2></div>
        <div class="column" id="negociacao"><h2>Negocia√ß√£o</h2></div>
        <div class="column" id="contrato-assinado"><h2>Contrato Assinado</h2></div>
        <div class="column" id="fechado"><h2>Fechado</h2></div>
    </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyAFJJAqVf3ge0WDHBpmS9E6sXKvnjuFkhw",
    authDomain: "dapapp-38637.firebaseapp.com",
    projectId: "dapapp-38637",
    storageBucket: "dapapp-38637.firebasestorage.app",
    messagingSenderId: "628852295313",
    appId: "1:628852295313:web:ce288c4e09b2037c022130",
    measurementId: "G-WL3JR7CSWY"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const clientesRef = collection(db, "clientes");

const STATUS = ['prospect', 'negociacao', 'contrato-assinado', 'fechado'];
let cardsMap = {};

// Criar card de cliente
function criarCardCliente(id, cliente) {
    const card = document.createElement('div');
    card.className = `card ${cliente.status}`;
    card.draggable = true;
    card.dataset.id = id;
    card.dataset.nome = cliente.nome.toLowerCase();
    card.dataset.status = cliente.status;

    card.innerHTML = `
        <h3>${cliente.nome}</h3>
        <p>${cliente.obs}</p>
        <button onclick="editarCliente('${id}')">‚úé</button>
        <button onclick="excluirCliente('${id}')">üóë</button>
    `;
    addDragEvents(card);
    document.getElementById(cliente.status).appendChild(card);
    cardsMap[id] = card;
}

// Adicionar cliente
async function novoCliente() {
    const nome = prompt('Nome do cliente:');
    if(!nome) return;
    const obs = prompt('Observa√ß√£o:') || '';
    let status = prompt('Status (prospect, negociacao, contrato-assinado, fechado):', 'prospect');
    if(!STATUS.includes(status)) return alert('Status inv√°lido');

    // Cria card imediatamente
    const tempId = 'temp_' + Date.now();
    criarCardCliente(tempId, { nome, obs, status });

    // Salva no Firestore
    try {
        const docRef = await addDoc(clientesRef, { nome, obs, status });
        // Atualiza card tempor√°rio para o ID real
        const card = cardsMap[tempId];
        card.dataset.id = docRef.id;
        cardsMap[docRef.id] = card;
        delete cardsMap[tempId];
    } catch(err) {
        alert('Erro ao salvar no Firestore: ' + err);
        // Remove card tempor√°rio se erro
        const card = cardsMap[tempId];
        card.remove();
        delete cardsMap[tempId];
    }
}

// Editar cliente
async function editarCliente(id) {
    const clienteDoc = doc(db, "clientes", id);
    const card = cardsMap[id];
    const novoNome = prompt('Editar nome:', card.querySelector('h3').innerText);
    if(!novoNome) return;
    const novaObs = prompt('Editar observa√ß√£o:', card.querySelector('p').innerText);
    let novoStatus = prompt('Editar status (prospect, negociacao, contrato-assinado, fechado):', card.dataset.status);
    if(!STATUS.includes(novoStatus)) return alert('Status inv√°lido');
    await updateDoc(clienteDoc, { nome: novoNome, obs: novaObs, status: novoStatus });
}

// Excluir cliente
async function excluirCliente(id) {
    if(confirm('Deseja realmente excluir este cliente?')){
        await deleteDoc(doc(db, "clientes", id));
    }
}

// Drag & Drop
const columns = document.querySelectorAll('.column');
let draggedCard = null;

function addDragEvents(card) {
    card.addEventListener('dragstart', () => { draggedCard = card; card.style.opacity = '0.5'; });
    card.addEventListener('dragend', () => { draggedCard = null; card.style.opacity = '1'; });
}

columns.forEach(col => {
    col.addEventListener('dragover', e => e.preventDefault());
    col.addEventListener('drop', async e => {
        if(draggedCard){
            const id = draggedCard.dataset.id;
            const status = col.id;
            const docRef = doc(db, "clientes", id);
            await updateDoc(docRef, { status });
        }
    });
});

// Busca e filtro
function filtrarClientes() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const filter = document.getElementById('filterStatus').value;
    Object.values(cardsMap).forEach(card => {
        const matchSearch = card.dataset.nome.includes(search);
        const matchFilter = !filter || card.dataset.status === filter;
        card.style.display = (matchSearch && matchFilter) ? 'block' : 'none';
    });
}

// Atualiza√ß√£o em tempo real
onSnapshot(clientesRef, snapshot => {
    STATUS.forEach(status => document.getElementById(status).innerHTML = `<h2>${status.replace(/-/g,' ').replace(/\b\w/g, l=>l.toUpperCase())}</h2>`);
    cardsMap = {};
    snapshot.docs.forEach(docSnap => criarCardCliente(docSnap.id, docSnap.data()));
    filtrarClientes();
});

// Tornar fun√ß√µes globais para onclick
window.novoCliente = novoCliente;
window.editarCliente = editarCliente;
window.excluirCliente = excluirCliente;
</script>

</body>
</html>
