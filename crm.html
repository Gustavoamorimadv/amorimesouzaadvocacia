<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRM - AMR ADV</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&display=swap" rel="stylesheet">
<style>
/* === Seu CSS Original com algumas adi√ß√µes === */
* { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', sans-serif; }
body { display:flex; background:#f0f2f5; height:100vh; overflow:hidden; }
.sidebar { width:80px; background:#1e1e2f; display:flex; flex-direction:column; align-items:center; padding:20px 0; flex-shrink:0; transition:width 0.4s ease; position:relative; z-index:10; }
.sidebar.expanded { width:220px; }
.sidebar h2 { font-size:22px; font-family:'Poppins', sans-serif; font-weight:600; color:#fff; letter-spacing:1px; margin-bottom:30px; text-align:center; cursor:pointer; width:100%; white-space:nowrap; overflow:hidden; transition:opacity 0.3s; opacity:0; }
.sidebar.expanded h2 { opacity:1; }
.sidebar button { width:100%; background:transparent; border:none; color:#fff; display:flex; align-items:center; gap:15px; padding:12px 20px; margin:5px 0; cursor:pointer; border-radius:10px; transition:background 0.3s, color 0.3s; font-size:14px; white-space:nowrap; overflow:hidden; }
.sidebar button img { width:28px; height:28px; filter: invert(1); flex-shrink:0; transition:transform 0.3s; }
.sidebar button span { display:inline-block; opacity:0; transition:opacity 0.3s; font-weight:500; }
.sidebar.expanded button span { opacity:1; }
.sidebar button:hover img { transform:scale(1.1); }
.sidebar button:hover { background:#2a2a40; color:#fff; }
.main { flex:1; display:flex; flex-direction:column; overflow:hidden; transition:filter 0.3s; }
.main.blur { filter:blur(4px) brightness(0.85); }
header { height:60px; background:#fff; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center; padding:0 20px; flex-shrink:0; }
header h1 { font-size:22px; color:#1e1e2f; font-family:'Poppins', sans-serif; }
header button { padding:8px 16px; background:#1e1e2f; color:#fff; border:none; border-radius:6px; cursor:pointer; }
.search-bar { padding:10px 20px; background:#fff; border-bottom:1px solid #ddd; display:flex; gap:10px; align-items:center; flex-shrink:0; }
.search-bar input, .search-bar select { padding:8px; border:1px solid #ccc; border-radius:6px; }
.search-bar input { flex:1; }
.kanban-container { flex:1; overflow-x:auto; padding:20px; }
.kanban { display:flex; gap:20px; min-width:max-content; height:100%; }
.column { background:#fff; border-radius:15px; padding:15px; min-width:320px; max-height:calc(100% - 20px); display:flex; flex-direction:column; gap:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); overflow-y:auto; }
.column h2 { margin-bottom:10px; font-size:18px; color:#1e1e2f; text-transform:uppercase; }
.card { display:flex; background:#fff; border-radius:15px; box-shadow:0 12px 30px rgba(0,0,0,0.12); overflow:hidden; transition:0.3s; min-height:160px; flex-direction:row; position:relative; }
/* Removido cursor:pointer do card, pois agora os bot√µes internos s√£o clic√°veis */
.card:hover { transform:scale(1.03); }
.card .color-bar { width:8px; height:100%; border-radius:15px 0 0 15px; }
.card-content { padding:20px; flex:1; display:flex; flex-direction:column; justify-content:center; }
.card h3 { font-size:20px; margin-bottom:6px; color:#333; }
.card p { font-size:14px; color:#555; margin:3px 0; }
.lista-fria .color-bar { background:#3498db; }
.negociacao .color-bar { background:#f1c40f; }
.contrato-assinado .color-bar { background:#9b59b6; }
.fechado .color-bar { background:#2ecc71; }
.card-actions { position:absolute; top:10px; right:10px; display:flex; gap:10px; }
.card-actions button { background:none; border:none; cursor:pointer; padding:4px; }
.card-actions img { width:20px; height:20px; opacity:0.7; transition:opacity 0.2s; }
.card-actions img:hover { opacity:1; }

/* Drag and Drop Feedback */
.card.dragging {
    opacity: 0.5;
    border: 2px dashed #007bff;
}
.column.drag-over {
    background: #e0e6ec;
    border: 2px dashed #007bff;
}

/* Estilo para a lista de documentos nos cards */
.document-list-container {
    margin-top: 10px;
    padding-top: 5px;
    border-top: 1px dashed #eee;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.document-link {
    font-size: 12px;
    color: #007bff;
    text-decoration: none;
    background: #f0f8ff;
    padding: 3px 6px;
    border-radius: 4px;
    transition: background 0.2s;
    max-width: 100%;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}
.document-link:hover {
    background: #e0f0ff;
    color: #0056b3;
}
.document-info {
    font-size: 12px;
    color: #999;
    margin-top: 10px !important;
}

/* Modal de Documentos */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none; /* Inicia oculto */
    justify-content: center;
    align-items: center;
    z-index: 100;
}
.modal-overlay.active {
    display: flex; /* Ativado pelo JS */
}
.modal-content {
    background: #fff;
    border-radius: 15px;
    padding: 30px;
    width: 500px;
    max-width: 90%;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.modal-content h2 {
    font-size: 24px;
    color: #1e1e2f;
    margin-bottom: 10px;
    text-align: center;
}
.modal-content input[type="text"],
.modal-content input[type="file"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 16px;
}
.modal-content button {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
}
.modal-content .upload-button {
    background: #1e1e2f;
    color: #fff;
}
.modal-content .upload-button:hover {
    background: #333;
}
.modal-content .close-button {
    background: #f0f0f0;
    color: #555;
    margin-top: 10px;
}
.modal-content .close-button:hover {
    background: #e0e0e0;
}
.modal-document-list {
    margin-top: 15px;
    border-top: 1px solid #eee;
    padding-top: 15px;
    max-height: 200px;
    overflow-y: auto;
}
.modal-document-list h3 {
    font-size: 18px;
    color: #333;
    margin-bottom: 10px;
}
.modal-document-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px dashed #f0f0f0;
}
.modal-document-item:last-child {
    border-bottom: none;
}
.modal-document-item a {
    color: #007bff;
    text-decoration: none;
    font-size: 15px;
    flex: 1;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}
.modal-document-item a:hover {
    text-decoration: underline;
}
.modal-document-item button {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    margin-left: 10px;
}
.modal-document-item button img {
    width: 18px;
    height: 18px;
    opacity: 0.7;
    transition: opacity 0.2s;
}
.modal-document-item button img:hover {
    opacity: 1;
}

.toast { position:fixed; right:20px; bottom:20px; background:#222; color:#fff; padding:8px 12px; border-radius:8px; box-shadow:0 6px 24px rgba(0,0,0,.3); display:none; z-index:60; }
</style>
</head>
<body>

<div class="sidebar">
    <h2 onclick="window.location.href='dashboard.html'">AMR ADV</h2>
    <button onclick="window.location.href='crm.html'"><img src="https://img.icons8.com/ios-filled/50/ffffff/dashboard.png"/><span>CRM</span></button>
    <button onclick="window.location.href='discador.html'"><img src="https://img.icons8.com/ios-filled/50/ffffff/phone.png"/><span>Discador</span></button>
</div>

<div class="main">
    <header>
        <h1>CRM</h1>
        <button id="addClientButton">Adicionar Cliente</button>
    </header>

    <div class="search-bar">
        <input id="searchInput" placeholder="Buscar cliente..." />
        <select id="filterStatus">
            <option value="">Todos os status</option>
            <option value="lista-fria">Lista Fria</option>
            <option value="negociacao">Negocia√ß√£o</option>
            <option value="contrato-assinado">Contrato Assinado</option>
            <option value="fechado">Fechado</option>
        </select>
    </div>

    <div class="kanban-container">
        <main class="kanban" id="kanban">
            <div class="column" id="lista-fria"><h2>LISTA FRIA</h2></div>
            <div class="column" id="negociacao"><h2>NEGOCIA√á√ÉO</h2></div>
            <div class="column" id="contrato-assinado"><h2>CONTRATO ASSINADO</h2></div>
            <div class="column" id="fechado"><h2>FECHADO</h2></div>
        </main>
    </div>
</div>

<div class="modal-overlay" id="documentModalOverlay">
    <div class="modal-content">
        <h2 id="documentModalTitle">Documentos de [Nome do Cliente]</h2>
        
        <label for="documentNameInput">Nome do Documento (Ex: RG, Contrato)</label>
        <input type="text" id="documentNameInput" placeholder="Nome do Documento" />
        
        <input type="file" id="documentFileInput" />
        <button class="upload-button" id="uploadDocumentButton">Upload e Salvar Documento</button>
        
        <div class="modal-document-list">
            <h3>Documentos Anexados</h3>
            <div id="attachedDocumentsList">
                <p>Nenhum documento anexado.</p>
            </div>
        </div>
        
        <button class="close-button" id="closeDocumentModalButton">Fechar</button>
    </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc, query, where, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js";

// Suas configura√ß√µes do Firebase
const firebaseConfig = {
    apiKey: "AIzaSyAFJJAqVf3ge0WDHBpmS9E6sXKvnjuFkhw",
    authDomain: "dapapp-38637.firebaseapp.com",
    projectId: "dapapp-38637",
    storageBucket: "dapapp-38637.appspot.com",
    messagingSenderId: "628852295313",
    appId: "1:628852295313:web:INSERIR_SEU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app); // Inicializa o Firebase Storage

const toastEl = document.getElementById('toast');

// Elementos do Modal de Documentos
const documentModalOverlay = document.getElementById('documentModalOverlay');
const documentModalTitle = document.getElementById('documentModalTitle');
const documentNameInput = document.getElementById('documentNameInput');
const documentFileInput = document.getElementById('documentFileInput');
const uploadDocumentButton = document.getElementById('uploadDocumentButton');
const attachedDocumentsList = document.getElementById('attachedDocumentsList');
const closeDocumentModalButton = document.getElementById('closeDocumentModalButton');

let clientes = [], currentUser = null;
let currentClientForDocuments = null; // Armazena o ID do cliente cujo modal de documentos est√° aberto

function showToast(msg){
    toastEl.innerText = msg;
    toastEl.style.display = 'block';
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(() => toastEl.style.display = 'none', 3000);
}

// Carrega clientes do Firestore
async function carregarClientes(){
    if(!currentUser) {
        console.log("Usu√°rio n√£o autenticado. N√£o √© poss√≠vel carregar clientes.");
        return;
    }
    const q = query(collection(db,"clientes"), where("userId","==",currentUser.uid));
    try {
        const snap = await getDocs(q);
        clientes = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderKanban();
    } catch (error) {
        console.error("Erro ao carregar clientes:", error);
        showToast("Erro ao carregar clientes.");
    }
}

// Fun√ß√£o auxiliar para criar links de documentos
function createDocumentLinks(documentos) {
    if (!documentos || documentos.length === 0) {
        return '<p class="document-info">Nenhum documento anexado.</p>';
    }
    const links = documentos.map(doc => `
        <a href="${doc.url}" target="_blank" class="document-link" title="Abrir ${doc.nome}">
            üîó ${doc.nome}
        </a>
    `).join('');
    return `<div class="document-list-container">${links}</div>`;
}


// Renderiza o Kanban
function renderKanban(){
    ['lista-fria','negociacao','contrato-assinado','fechado'].forEach(id=>{
        const col = document.getElementById(id);
        col.innerHTML = `<h2>${col.querySelector('h2').innerText}</h2>`; 
    });

    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const filterStatus = document.getElementById('filterStatus').value;

    clientes.filter(cliente => {
        const matchesSearch = searchTerm === '' || 
                              cliente.nome.toLowerCase().includes(searchTerm) ||
                              (cliente.cpf && cliente.cpf.includes(searchTerm)); 
        const matchesStatus = filterStatus === '' || (cliente.status === filterStatus);
        return matchesSearch && matchesStatus;
    }).forEach(cliente => {
        const status = cliente.status || 'lista-fria'; 
        const col = document.getElementById(status);
        if (!col) {
            console.warn(`Coluna com status '${status}' n√£o encontrada para o cliente ${cliente.id}`);
            return;
        }

        const card = document.createElement('div');
        card.className = `card ${status}`; 
        card.draggable = true;
        card.dataset.id = cliente.id;
        card.innerHTML = `<div class="color-bar"></div>
        <div class="card-content">
            <h3>${cliente.nome}</h3>
            <p>CPF: ${cliente.cpf || '-'}</p>
            <p>Classe: ${cliente.classe || '-'}</p>
            <p>Valor: R$ ${cliente.valor || 0}</p>
            <p>Andamento: ${cliente.andamento || '-'}</p>
            
            ${createDocumentLinks(cliente.documentos)} 
        </div>
        <div class="card-actions">
            <button onclick="window.openDocumentModal('${cliente.id}', '${cliente.nome}')">
                <img src="https://img.icons8.com/material-outlined/24/000000/document.png" alt="Documentos"/>
            </button>
            <button onclick="window.ligarManual('${cliente.numeros || ''}')"><img src="https://img.icons8.com/ios-glyphs/30/000000/phone.png"/></button>
            <button onclick="window.whatsapp('${cliente.numeros || ''}')"><img src="https://img.icons8.com/ios-glyphs/30/000000/whatsapp.png"/></button>
        </div>`;
        col.appendChild(card);
    });

    addDragAndDrop();
}

// Drag and Drop
function addDragAndDrop(){
    const cards = document.querySelectorAll('.card');
    const columns = document.querySelectorAll('.column');

    cards.forEach(card=>{
        card.addEventListener('dragstart', e=>{
            e.dataTransfer.setData('text/plain', card.dataset.id);
            card.classList.add('dragging'); 
        });

        card.addEventListener('dragend', e=>{
            card.classList.remove('dragging'); 
        });
    });

    columns.forEach(col=>{
        col.addEventListener('dragover', e=> {
            e.preventDefault(); 
            col.classList.add('drag-over'); 
        });

        col.addEventListener('dragleave', e=> {
            col.classList.remove('drag-over'); 
        });

        col.addEventListener('drop', async e=>{
            e.preventDefault();
            col.classList.remove('drag-over'); 
            const id = e.dataTransfer.getData('text/plain');
            const card = document.querySelector(`.card[data-id='${id}']`);
            if (!card) return; 

            const oldStatus = card.parentElement.id; 
            const newStatus = col.id; 

            if (oldStatus !== newStatus) {
                card.classList.remove(oldStatus);
                card.classList.add(newStatus);
                col.appendChild(card);

                const clienteRef = doc(db,'clientes',id);
                try {
                    await updateDoc(clienteRef, { status: newStatus });
                    clientes = clientes.map(c => c.id===id ? {...c, status: newStatus} : c);
                    showToast(`Cliente movido para ${newStatus.toUpperCase().replace('-', ' ')}!`);
                } catch (error) {
                    console.error("Erro ao atualizar status do cliente:", error);
                    showToast("Erro ao atualizar status.");
                    document.getElementById(oldStatus).appendChild(card); 
                    card.classList.remove(newStatus); 
                    card.classList.add(oldStatus); 
                }
            }
        });
    });
}

// === Fun√ß√µes do Modal de Documentos ===

window.openDocumentModal = (clientId, clientName) => {
    currentClientForDocuments = clientId;
    documentModalTitle.innerText = `Documentos de ${clientName}`;
    documentNameInput.value = '';
    documentFileInput.value = ''; // Limpa o input de arquivo
    loadAttachedDocuments(clientId); // Carrega e exibe os documentos existentes
    documentModalOverlay.classList.add('active');
};

closeDocumentModalButton.addEventListener('click', () => {
    documentModalOverlay.classList.remove('active');
    currentClientForDocuments = null;
    carregarClientes(); // Recarrega os clientes para atualizar os cards no Kanban
});

async function loadAttachedDocuments(clientId) {
    const cliente = clientes.find(c => c.id === clientId);
    const documentos = cliente ? cliente.documentos : [];
    
    attachedDocumentsList.innerHTML = ''; // Limpa a lista antes de adicionar
    
    if (!documentos || documentos.length === 0) {
        attachedDocumentsList.innerHTML = '<p>Nenhum documento anexado.</p>';
        return;
    }

    documentos.forEach(doc => {
        const docItem = document.createElement('div');
        docItem.className = 'modal-document-item';
        docItem.innerHTML = `
            <a href="${doc.url}" target="_blank">${doc.nome}</a>
            <button onclick="window.deleteDocument('${clientId}', '${doc.nome}', '${doc.url}')">
                <img src="https://img.icons8.com/ios-glyphs/30/000000/trash.png" alt="Excluir"/>
            </button>
        `;
        attachedDocumentsList.appendChild(docItem);
    });
}

uploadDocumentButton.addEventListener('click', async () => {
    if (!currentClientForDocuments) {
        showToast("Nenhum cliente selecionado para anexar documentos.");
        return;
    }
    const documentName = documentNameInput.value.trim();
    const file = documentFileInput.files[0];

    if (!documentName || !file) {
        showToast("Por favor, preencha o nome do documento e selecione um arquivo.");
        return;
    }

    showToast("Iniciando upload do documento...");
    uploadDocumentButton.disabled = true;

    try {
        const storageRef = ref(storage, `clientes/${currentClientForDocuments}/documentos/${file.name}`);
        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on('state_changed', 
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                showToast(`Upload: ${progress.toFixed(0)}%`);
            }, 
            (error) => {
                console.error("Erro no upload:", error);
                showToast("Erro no upload do documento.");
            }, 
            async () => {
                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                const clientRef = doc(db, 'clientes', currentClientForDocuments);
                
                await updateDoc(clientRef, {
                    documentos: arrayUnion({ nome: documentName, url: downloadURL, path: storageRef.fullPath })
                });
                
                showToast("Documento enviado e salvo!");
                documentNameInput.value = '';
                documentFileInput.value = '';
                loadAttachedDocuments(currentClientForDocuments); // Atualiza a lista no modal
                uploadDocumentButton.disabled = false;
            }
        );
    } catch (error) {
        console.error("Erro ao subir documento:", error);
        showToast("Erro ao subir documento.");
        uploadDocumentButton.disabled = false;
    }
});

window.deleteDocument = async (clientId, docName, docUrl) => {
    if (!confirm(`Tem certeza que deseja excluir o documento "${docName}"?`)) {
        return;
    }

    showToast("Excluindo documento...");
    try {
        const clientRef = doc(db, 'clientes', clientId);
        const cliente = clientes.find(c => c.id === clientId);
        const docToDelete = cliente.documentos.find(d => d.nome === docName && d.url === docUrl);

        if (docToDelete && docToDelete.path) { // O 'path' √© crucial para deletar do Storage
            const fileRef = ref(storage, docToDelete.path);
            await deleteObject(fileRef); // Deleta do Firebase Storage
        }

        await updateDoc(clientRef, {
            documentos: arrayRemove({ nome: docName, url: docUrl, path: docToDelete.path })
        });
        
        showToast("Documento exclu√≠do com sucesso!");
        loadAttachedDocuments(clientId); // Atualiza a lista no modal
    } catch (error) {
        console.error("Erro ao excluir documento:", error);
        showToast("Erro ao excluir documento.");
    }
};


// === Fun√ß√µes de Liga√ß√£o/WhatsApp (Se voc√™ tiver a integra√ß√£o Twilio via Firebase Functions) ===
// Estas fun√ß√µes s√£o placeholders. Se voc√™ tem as fun√ß√µes Twilio no Firebase Functions,
// importe getFunctions e httpsCallable e implemente-as aqui.
// Por exemplo:
// import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-functions.js";
// const functions = getFunctions(app);
// const makeCallFunction = httpsCallable(functions, 'makeCall');
// window.ligarManual = async (numero) => { /* ... sua l√≥gica de chamada ... */ };
// window.whatsapp = async (numero) => { /* ... sua l√≥gica de whatsapp ... */ };

// Placeholder para ligarManual e whatsapp, caso n√£o use Firebase Functions ou Twilio aqui
window.ligarManual = (numeros) => {
    if (!numeros) { showToast("N√∫mero n√£o informado."); return; }
    alert(`Simulando liga√ß√£o para: ${numeros.split(',')[0].trim()}. (Integre com Twilio via Firebase Functions)`);
    console.log("Chamada simulada para:", numeros);
};
window.whatsapp = (numeros) => {
    if (!numeros) { showToast("N√∫mero n√£o informado."); return; }
    // Abrir WhatsApp Web/App
    window.open(`https://wa.me/${numeros.split(',')[0].trim().replace(/\D/g,'')}`, '_blank');
    showToast("Abrindo WhatsApp...");
    console.log("WhatsApp aberto para:", numeros);
};


// Busca e filtro
document.getElementById('searchInput').addEventListener('input', renderKanban);
document.getElementById('filterStatus').addEventListener('change', renderKanban);

// Autentica√ß√£o Firebase
onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        console.log("Usu√°rio logado:", user.uid);
        carregarClientes();
    } else {
        console.log("Nenhum usu√°rio logado. Redirecionando para login.html");
        window.location.href = 'login.html';
    }
});

</script>

</body>
</html>
