<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CRM AMR ADV - Processos</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0; padding: 0;
      background: #f4f6f9;
    }
    header {
      background: #1a237e;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      padding: 10px;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 15px;
      overflow: hidden;
    }
    .card-header {
      background: #eceff1;
      padding: 12px 15px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-header h3 {
      margin: 0;
      font-size: 16px;
      color: #333;
    }
    .card-body {
      padding: 15px;
      display: none;
    }
    .processo {
      margin-bottom: 15px;
      padding: 10px;
      border-left: 4px solid #1a237e;
      background: #f9f9f9;
      border-radius: 6px;
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 14px;
      color: #333;
    }
    input {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 10px;
      padding: 8px 12px;
      background: #1a237e;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover { background: #0d1757; }
  </style>
</head>
<body>
  <header>ðŸ“‚ Processos - Clientes Fechados</header>
  <div class="container" id="clientes"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ðŸ”¥ ConfiguraÃ§Ã£o Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAFJJAqVf3ge0WDHBpmS9E6sXKvnjuFkhw",
      authDomain: "dapapp-38637.firebaseapp.com",
      projectId: "dapapp-38637",
      storageBucket: "dapapp-38637.appspot.com",
      messagingSenderId: "628852295313",
      appId: "1:628852295313:web:INSERIR_SEU_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const clientesContainer = document.getElementById("clientes");

    async function carregarClientes() {
      clientesContainer.innerHTML = "<p>Carregando clientes...</p>";
      const snapshot = await getDocs(collection(db, "clientes"));

      clientesContainer.innerHTML = "";

      snapshot.forEach(docSnap => {
        const cliente = docSnap.data();
        const clienteId = docSnap.id;

        if (cliente.status === "fechado") {
          const card = document.createElement("div");
          card.className = "card";

          const header = document.createElement("div");
          header.className = "card-header";
          header.innerHTML = `<h3>${cliente.nome} - ${cliente.cpf}</h3><span>â–¼</span>`;
          header.addEventListener("click", () => {
            const body = card.querySelector(".card-body");
            body.style.display = body.style.display === "none" ? "block" : "none";
          });

          const body = document.createElement("div");
          body.className = "card-body";

          const processosStr = cliente.processo || "";
          const numeros = processosStr.split(",").map(p => p.trim()).filter(p => p.length > 0);

          numeros.forEach((numero, index) => {
            const processoDiv = document.createElement("div");
            processoDiv.className = "processo";

            const valorInputId = `valor-${clienteId}-${index}`;
            const movInputId = `mov-${clienteId}-${index}`;

            processoDiv.innerHTML = `
              <p><b>NÃºmero:</b> ${numero}</p>
              <label>Valor da causa:</label>
              <input type="text" id="${valorInputId}" placeholder="Digite o valor da causa">
              <label>Ãšltima movimentaÃ§Ã£o:</label>
              <input type="text" id="${movInputId}" placeholder="Digite a Ãºltima movimentaÃ§Ã£o">
              <button type="button" data-cliente="${clienteId}" data-numero="${numero}" data-valor="${valorInputId}" data-mov="${movInputId}">
                Salvar
              </button>
            `;

            // ðŸ”¥ Evita que clique dentro do card feche ele
            processoDiv.querySelectorAll("input, button").forEach(el => {
              el.addEventListener("click", e => e.stopPropagation());
            });

            body.appendChild(processoDiv);
          });

          // evento salvar
          body.addEventListener("click", async e => {
            if (e.target.tagName === "BUTTON") {
              const clienteId = e.target.dataset.cliente;
              const numero = e.target.dataset.numero;
              const valor = document.getElementById(e.target.dataset.valor).value;
              const movimentacao = document.getElementById(e.target.dataset.mov).value;

              const docRef = doc(db, "clientes", clienteId);

              // ðŸ”¥ Atualiza campo processos
              await updateDoc(docRef, {
                [`processos.${numero}`]: {
                  valorCausa: valor,
                  ultimaMovimentacao: movimentacao
                }
              });

              alert("Processo atualizado com sucesso!");
            }
          });

          card.appendChild(header);
          card.appendChild(body);
          clientesContainer.appendChild(card);
        }
      });
    }

    carregarClientes();
  </script>
</body>
</html>
